<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitiFlow Studio - Chatbot Builder Platform</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">CF</div>
                <div class="logo-text">
                    <h1>CitiFlow Studio</h1>
                    <p>Enterprise Chatbot Builder Platform</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="loadTemplateBtn">
                    üìã Load Template
                </button>
                <button class="btn btn-primary" id="masterTemplateBtn" onclick="openMasterTemplateModal()" title="Build a unified bot with multiple templates">
                    üèóÔ∏è Build Unified Bot
                </button>
                <button class="btn btn-secondary" id="exportJSONBtn">
                    üíæ Export JSON
                </button>
                <button class="btn btn-success" id="importJSONBtn" title="Import JSON flow configuration">
                    üìÅ Import JSON
                </button>
                <button class="btn btn-success" id="deployFlowBtn" title="Deploy your flow to the Live Preview">
                    üöÄ Deploy & Test Flow
                </button>
                <button class="btn-help" id="helpBtn" title="Help & Getting Started">
                    ‚ùì
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Studio Panel -->
            <div class="studio-panel">
                <div class="studio-tabs">
                    <div class="tab active" onclick="switchTab('builder', event)">Flow Builder</div>
                    <div class="tab" onclick="switchTab('json', event)">JSON Configuration</div>
                </div>

                <div class="studio-workspace">
                    <!-- Builder View -->
                    <div id="builderView" class="builder-view">
                        <!-- Node Palette with Tabs -->
                        <div class="node-palette">
                            <!-- Palette Tabs -->
                            <div class="palette-tabs">
                                <div class="palette-tab active" onclick="switchPaletteTab('nodes')">üì¶ Nodes</div>
                                <div class="palette-tab" onclick="switchPaletteTab('apis')">üîå APIs</div>
                            </div>

                            <!-- Palette Content -->
                            <div class="palette-content">
                                <!-- Nodes Tab -->
                                <div id="nodesTab" class="palette-tab-pane active">
                            <div class="palette-section">
                                <div class="palette-title">Flow Control</div>
                                <div class="node-item" draggable="true" data-type="START" title="The entry point for your chatbot flow. Every flow must begin with a Start node.">
                                    <div class="node-icon" style="background: #10b981;">üèÅ</div>
                                    <div class="node-info">
                                        <div class="node-name">Start</div>
                                        <div class="node-desc">Entry point</div>
                                    </div>
                                </div>
                                <div class="node-item" draggable="true" data-type="END" title="Terminates the current conversation path. Use this to conclude a flow successfully or after an error.">
                                    <div class="node-icon" style="background: #ef4444;">üõë</div>
                                    <div class="node-info">
                                        <div class="node-name">End Flow</div>
                                        <div class="node-desc">Terminate</div>
                                    </div>
                                </div>
                                <div class="node-item" draggable="true" data-type="CONDITIONAL" title="Creates a logical branch in your flow. Routes users to different paths based on whether a variable meets a specific condition (e.g., true/false).">
                                    <div class="node-icon" style="background: #f59e0b;">üîÄ</div>
                                    <div class="node-info">
                                        <div class="node-name">Condition</div>
                                        <div class="node-desc">Branch logic</div>
                                    </div>
                                </div>
                            </div>

                            <div class="palette-section">
                                <div class="palette-title">User Interaction</div>
                                <div class="node-item" draggable="true" data-type="MESSAGE" title="Displays a text message to the user. Use this to provide information or ask questions without requiring a button response.">
                                    <div class="node-icon" style="background: #3b82f6;">üí¨</div>
                                    <div class="node-info">
                                        <div class="node-name">Message</div>
                                        <div class="node-desc">Display text</div>
                                    </div>
                                </div>
                                <div class="node-item" draggable="true" data-type="MENU" title="Displays a message along with interactive buttons. Use this to present choices to the user and guide them through the flow.">
                                    <div class="node-icon" style="background: #8b5cf6;">üìã</div>
                                    <div class="node-info">
                                        <div class="node-name">Menu</div>
                                        <div class="node-desc">Show buttons</div>
                                    </div>
                                </div>
                            </div>

                            <div class="palette-section">
                                <div class="palette-title">Integration</div>
                                <div class="node-item" draggable="true" data-type="API" title="Integrates with external systems by making an API call. Use this to fetch data (e.g., account balance) or send data (e.g., make a payment).">
                                    <div class="node-icon" style="background: #06b6d4;">üîå</div>
                                    <div class="node-info">
                                        <div class="node-name">API Call</div>
                                        <div class="node-desc">External data</div>
                                    </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- APIs Tab -->
                                <div id="apisTab" class="palette-tab-pane">
                                    <div class="api-search-container">
                                        <input type="text" class="api-search" id="apiSearch" placeholder="üîç Search APIs..." onkeyup="searchAPIs()">
                                        <div class="api-count" id="apiCount"></div>
                                    </div>
                                    <div id="apiLibrary"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Canvas -->
                        <div class="canvas-container" id="canvasContainer">
                            <div class="canvas" id="canvas">
                                <svg id="connectionSvg">
                                    <defs>
                                        <!-- Arrow markers for different connection types -->
                                        <marker id="arrowSuccess" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L0,6 L9,3 z" class="connection-arrow success" />
                                        </marker>
                                        <marker id="arrowError" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L0,6 L9,3 z" class="connection-arrow error" />
                                        </marker>
                                        <marker id="arrowDefault" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L0,6 L9,3 z" class="connection-arrow default" />
                                        </marker>
                                        <marker id="arrowButton" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L0,6 L9,3 z" class="connection-arrow button" />
                                        </marker>
                                        <marker id="arrowManual" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                                            <path d="M0,0 L0,6 L9,3 z" class="connection-arrow manual" />
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Config Panel -->
                    <div class="config-panel" id="configPanel">
                        <!-- Content will be rendered dynamically by JavaScript -->
                    </div>
                    
                    <!-- Build Assist Button -->
                    <button class="build-assist-btn" id="buildAssistBtn" onclick="toggleBuildAssistPanel()" title="Get AI help building your flow">
                        <div class="assist-btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                <circle cx="9" cy="10" r="1"></circle>
                                <circle cx="15" cy="10" r="1"></circle>
                                <path d="M9 14h6"></path>
                            </svg>
                            <span class="assist-btn-pulse"></span>
                        </div>
                        <div class="assist-btn-text">
                            <span class="assist-btn-title">Build Assist</span>
                            <span class="assist-btn-subtitle">AI Helper</span>
                        </div>
                    </button>
                    
                    <!-- JSON Configuration View -->
                    <div id="jsonView" class="json-view">
                        <div class="json-header">
                            <h3>JSON Configuration</h3>
                            <div class="json-actions">
                                <button class="btn btn-primary" id="importJSONBtn2">
                                    üìÅ Import JSON File
                                </button>
                                <button class="btn btn-secondary" id="exportJSONBtn2">
                                    üíæ Export Current Flow
                                </button>
                                <button class="btn btn-success" id="loadJSONFromTextBtn">
                                    üì• Load from Text
                                </button>
                            </div>
                        </div>
                        <div class="json-content">
                            <textarea id="jsonTextArea" class="json-textarea" 
                                      placeholder="Paste JSON configuration here or drag & drop a JSON file..." 
                                      ondrop="handleJSONDrop(event)"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="preview-panel">
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-header-left">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </div>
                        <div class="chat-header-center">
                            <div class="chat-avatar">
                                <span class="citi-logo-text">citi</span>
                            </div>
                            <div class="chat-info">
                                <h3>Citi¬Æ Bot</h3>
                                <p>Connected</p>
                            </div>
                        </div>
                        <div class="chat-header-right">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-vertical"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="timestamp">Today 3:47 PM</div>
                        <div class="preview-instructions" id="previewInstructions">
                            <div class="preview-instructions-icon">üöÄ</div>
                            <h3>Ready to Test Your Flow!</h3>
                            <p>Click the <strong>"üöÄ Deploy Flow"</strong> button above to start testing your chatbot in this preview area.</p>
                            <div class="preview-instructions-steps">
                                <strong>Quick Start:</strong>
                                <ol>
                                    <li>Load a template OR build your flow</li>
                                    <li>Click <strong>"üöÄ Deploy Flow"</strong> button (top)</li>
                                    <li>Chat interface will appear here</li>
                                    <li>Test your bot by clicking buttons!</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <input type="text" class="chat-input" placeholder="Write a message...">
                        <button class="send-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Load Template</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <!-- Content will be dynamically populated from catalog.json -->
        </div>
    </div>

    <!-- Master Template Builder Modal -->
    <div class="modal" id="masterTemplateModal">
        <div class="modal-content master-template-content">
            <div class="modal-header">
                <h2 class="modal-title">üèóÔ∏è Build Unified Banking Bot</h2>
                <button class="modal-close" onclick="closeMasterTemplateModal()">√ó</button>
            </div>
            
            <div class="master-template-body">
                <div class="step-indicator">
                    <div class="step active" data-step="1">1. Select Categories</div>
                    <div class="step" data-step="2">2. Choose Templates</div>
                    <div class="step" data-step="3">3. Configure Menu</div>
                    <div class="step" data-step="4">4. Generate Bot</div>
                </div>
                
                <!-- Step 1: Category Selection -->
                <div class="step-content active" id="step1">
                    <h3>Select Service Categories</h3>
                    <p class="step-description">Choose which types of banking services you want to include in your unified bot</p>
                    <div class="category-grid">
                        <div class="category-card" data-category="credit_cards">
                            <input type="checkbox" class="category-checkbox" value="credit_cards" id="cat-credit-cards">
                            <div class="category-icon">üí≥</div>
                            <h4>Credit Card Services</h4>
                            <p>Card management, payments, disputes, rewards</p>
                            <div class="category-count" id="count-credit-cards">10 templates</div>
                        </div>
                        
                        <div class="category-card" data-category="retail_banking">
                            <input type="checkbox" class="category-checkbox" value="retail_banking" id="cat-retail-banking">
                            <div class="category-icon">üè¶</div>
                            <h4>Banking Services</h4>
                            <p>Transfers, deposits, loans, account management</p>
                            <div class="category-count" id="count-retail-banking">8 templates</div>
                        </div>
                        
                        <div class="category-card" data-category="getting_started">
                            <input type="checkbox" class="category-checkbox" value="getting_started" id="cat-getting-started">
                            <div class="category-icon">üöÄ</div>
                            <h4>Quick Services</h4>
                            <p>Essential banking functions</p>
                            <div class="category-count" id="count-getting-started">4 templates</div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Template Selection -->
                <div class="step-content" id="step2">
                    <h3>Choose Specific Templates</h3>
                    <p class="step-description">Select individual templates to include from your chosen categories</p>
                    <div id="templateSelectionContainer">
                        <!-- Dynamically populated based on selected categories -->
                    </div>
                </div>
                
                <!-- Step 3: Menu Configuration -->
                <div class="step-content" id="step3">
                    <h3>Configure Main Menu</h3>
                    <p class="step-description">Customize your bot's appearance and navigation structure</p>
                    <div class="menu-config">
                        <label>Bot Name:</label>
                        <input type="text" id="botName" value="Citi Banking Assistant" placeholder="Enter bot name">
                        
                        <label>Welcome Message:</label>
                        <textarea id="welcomeMessage" placeholder="Welcome! How can I help you today?">Welcome to Citi Banking Assistant! How can I help you today?</textarea>
                        
                        <label>Menu Organization:</label>
                        <select id="menuStyle">
                            <option value="category">By Category (Credit Cards, Banking, etc.)</option>
                            <option value="flat">Flat List (All Services)</option>
                        </select>

                        <label>
                            <input type="checkbox" id="includeSupport" checked>
                            Include Support/Contact option
                        </label>
                    </div>
                </div>
                
                <!-- Step 4: Generation -->
                <div class="step-content" id="step4">
                    <h3>Ready to Generate</h3>
                    <p class="step-description">Review your selections and generate your unified banking bot</p>
                    <div class="generation-summary" id="generationSummary">
                        <!-- Summary will be populated -->
                    </div>
                    <button class="generate-btn" onclick="generateUnifiedBot()">üöÄ Generate Unified Bot</button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" id="prevStepBtn" onclick="previousStep()">‚Üê Previous</button>
                <button class="btn-primary" id="nextStepBtn" onclick="nextStep()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="success-toast" id="successToast"></div>

    <!-- Help Panel -->
    <div class="help-overlay" id="helpOverlay" onclick="toggleHelpPanel()"></div>
    <div class="help-panel" id="helpPanel">
        <div class="help-panel-header">
            <div class="help-panel-title">‚ùì Help & Getting Started</div>
            <button class="help-panel-close" onclick="toggleHelpPanel()">√ó</button>
        </div>
        <div class="help-panel-content">
            <input type="text" class="faq-search" id="faqSearch" placeholder="üîç Search help topics..." onkeyup="searchFAQs()">
            <div id="faqContent"></div>
        </div>
    </div>

    <!-- Connection Editor Popup -->
    <div class="connection-editor-overlay" id="connectionEditorOverlay" onclick="closeConnectionEditor()"></div>
    <div class="connection-editor" id="connectionEditor">
        <div class="connection-editor-header">
            <div class="connection-editor-icon">üîó</div>
            <div class="connection-editor-title">Connection Details</div>
            <button class="connection-editor-close" onclick="closeConnectionEditor()">√ó</button>
        </div>
        <div class="connection-info" id="connectionInfo">
            <!-- Connection details will be populated here -->
        </div>
        <div class="connection-editor-actions">
            <button class="btn-connection edit" id="btnEditConnection">‚úèÔ∏è Edit Source Node</button>
            <button class="btn-connection delete" id="btnDeleteConnection">üóëÔ∏è Delete Connection</button>
        </div>
    </div>

    <!-- Build Assist Panel -->
    <div class="build-assist-panel" id="buildAssistPanel">
        <div class="build-assist-header">
            <div class="build-assist-title">ü§ñ Build Assist</div>
            <button class="build-assist-close" onclick="toggleBuildAssistPanel()">√ó</button>
        </div>
        <div class="build-assist-messages" id="assistMessages">
            <div class="assist-message bot">
                Hi! I'm here to help you build banking flows. Ask me for step-by-step instructions, like "Help me build a card replacement flow."
            </div>
        </div>
        <div class="build-assist-input-container">
            <input type="text" id="assistInput" class="build-assist-input" placeholder="Ask for help...">
            <button class="build-assist-send-btn" id="assistSendBtn">Send</button>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>

